<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Timeplan, men den fungerer faktisk</title>

    <link href="https://fonts.googleapis.com/css?family=Reem+Kufi|Roboto:300" rel="stylesheet">
    <link rel="stylesheet" href="main.css">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="msapplication-starturl" content="/">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<link href="https://use.fontawesome.com/releases/v5.12.0/css/all.css" rel="stylesheet">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#485564">
    <link rel="shortcut icon" href="/icons/favicon.ico">
    <meta name="apple-mobile-web-app-title" content="Timeplan">
    <meta name="application-name" content="Timeplan">
    <meta name="msapplication-TileColor" content="#485564">
    <meta name="msapplication-TileImage" content="/icons/mstile-144x144.png">
    <meta name="msapplication-config" content="/icons/browserconfig.xml">
    <meta name="theme-color" content="#485564">
    <script> if ("serviceWorker" in navigator && !navigator.serviceWorker.controller) navigator.serviceWorker.register("pwa.js", { scope: "./" }) .then(reg => console.log("[PWA] Service worker has been registered for scope: " + reg.scope)); </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-153861801-5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-153861801-5');
    </script>
  </head>
  <body>
    <main style="background:#485564;color:#FAFAFA" id="mainbody">
      <div class="details" id="datetoday"></div>
      <div class="title" id="classtitle">Laster ...</div>
      <div class="details" id="messages"></div>
      <div class="footer" style="position:fixed;left:0;bottom:0;width:100%;text-align:right;padding:5px;"><a href="/">timeplan.but-it-actually.works</a> <a class="icon" href="//www.linkedin.com/in/galudvigsen/"><i class="fab fa-linkedin"></i></a></div>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
      let
        colors = {
          "Naturfag": "AADDAA",
          "Kropps√∏ving": "AADDDD",
          "Samfunnsfag": "DDCCAA",
          "Norsk": "DDAAAA",
          "Matematikk": "AAADDD",
          "Engelsk": "DDDDAA",
          "Valgfag": "DDAADD",
          "Spr√•k": "AACCDD",
          "Kunst og h√•ndverk": "CCDDAA",
          "Utdanningsvalg": "BAAADD",
          "Musikk": "BEAADD",
          "Mat og helse": "DDAACA",
          "KRLE": "DDDAAA",
          "Friminutt": "DDDDDD",
          "Vanilla": "FAFAFA",
          "Feil": "FF9999"
        }, classes = ["8A", "8B", "8C", "8D", "8E", "9A", "9B", "9C", "9D", "9E", "10A", "10B", "10C", "10D", "10E"],
        otherColors = "background:#485564;color:#",
        classMatches = window.location.hash ? window.location.hash.match(/[0-9][0-9]?[A-E]/gmi) : undefined,
        data = { loading: null, class: classMatches && classes.includes(classMatches[0].toUpperCase()) ? classMatches[0].toUpperCase() : classMatches },
        offset = 0
      
      if (!data.class) {
        document.getElementById('classtitle').innerText = "Finn klasserommet ditt!"
        document.getElementById('messages').innerHTML = classes.map(cl => "<a href=\"#" + cl + "\" onclick=\"updateClass()\">" + cl + "</a>").join(" - ")
      } else startSequence();
      
      async function updateClass() {
        await new Promise(resolve => setInterval(resolve, 1)) // vi venter bittelitt s√• window.location har oppdatert seg
        classMatches = window.location.hash ? window.location.hash.match(/[0-9][0-9]?[A-E]/gmi) : undefined;
        data.class = classMatches ? classMatches[0] : classMatches;

        if (data.class) startSequence();
        return data.class;
      }

      async function startSequence() {
        document.getElementById('classtitle').innerText = "Laster ...";
        document.getElementById('messages').innerText = "";

        data = await fetchInfo().catch(() => null);
        if (!data) {
          document.getElementById('classtitle').innerText = "Noe gikk galt ..."
          document.getElementById('messages').innerHTML = "Dette klasserommet finnes ikke!"
          document.getElementById('mainbody').style = otherColors + colors.Feil
          return;
        }
        update(); setInterval(update, 1000); setInterval(fetchInfo, 300000);
        return;
      }

      function fetchInfo() {
        return new Promise((resolve, reject) => $.ajax({
          url: "https://skkvapi.but-it-actually.works/timeplan/" + data.class,
          type: "GET",
          dataType: 'json',
          success: resolve,
          error: reject
        }))
      }

      function update() {
          if (data.loading) return; // vi venter til den er ferdig lastet

          let date = new Date(), day = date.getDay() - 1, now = Date.now() + offset;
          if (day == -1) day = 6;

          let today = data.days[day];
          if (!today) { // helg sannsynligvis
            document.getElementById('datetoday').innerText = ""
            document.getElementById('classtitle').innerText = "Det er helg üéâ"
            document.getElementById('messages').innerText = ""
            document.getElementById('mainbody').style = otherColors + colors.Vanilla
          } else { // skole
            document.getElementById('datetoday').innerText = today.title + ", uke " + ISO8601_week_no(new Date())
            let classnow = today.topics.find(t => t.timeStart < now && now < t.timeEnd);
            if (!classnow) { // ikke time atm
              let start = today.topics[0].timeStart, end = today.topics[today.topics.length - 1].timeEnd;
              if (start < now && now < end) { // pause sannsynligvis
                for (let topic of today.topics) if (now < topic.timeEnd) {
                  document.getElementById('classtitle').innerText = "Friminutt!"
                  document.getElementById('messages').innerText = msToTime(topic.timeStart - now, true) + " til " + topic.name
                  document.getElementById('mainbody').style = otherColors + colors.Friminutt
                  break;
                }
              } else { // ikke pause sannsynligvis, heller f√∏r eller etter skolen
                if (start >= now) { // f√∏r skolen
                  let topic = today.topics[0]
                  document.getElementById('classtitle').innerText = "God morgen! F√∏rste time er " + topic.name + " om " + msToTime(topic.timeStart - now, true)
                  document.getElementById('messages').innerHTML = data.messages.map(m => formatXML(m)).join("<br/>")
                  document.getElementById('mainbody').style = otherColors + (colors[topic.name] || colors.Vanilla)
                } else { // etter skolen
                  document.getElementById('classtitle').innerText = day == 4 ? "God helg! üéâ" : "God kveld!"
                  let tomorrow = data.days[day + 1], homeworkTomorrow = tomorrow && tomorrow ? tomorrow.topics.map(t => t.homework.map(h => "<b>" + t.name + ":</b> " + formatXML(h))).flat(Infinity) : []
                  document.getElementById('messages').innerHTML = homeworkTomorrow.length ? "<b>Lekser til i morgen:</b><br/>" + homeworkTomorrow.join("<br/>") : ""
                  document.getElementById('mainbody').style = otherColors + colors.Vanilla
                }
              }
            } else { // time n√•
              document.getElementById('classtitle').innerText = classnow.name
              let next = today.topics.find(topic => topic.timeStart == classnow.timeEnd), nextTopic = today.topics[today.topics.indexOf(classnow) + 1]
              document.getElementById('messages').innerText = msToTime(now - classnow.timeStart, true) + " passert  -  " + msToTime(classnow.timeEnd - now, true) + " gjenst√•r" + (nextTopic ? " til " + (next ? next.name : "friminutt") : "")
              document.getElementById('mainbody').style = otherColors + (colors[classnow.name] || colors.Vanilla)
            }
          }
        }
        
        function msToTime(ms, short = false) {
          days = Math.floor(ms / 86400000); // 24*60*60*1000
          daysms = ms % 86400000; // 24*60*60*1000
          hours = Math.floor(daysms / 3600000); // 60*60*1000
          hoursms = ms % 3600000; // 60*60*1000
          minutes = Math.floor(hoursms / 60000); // 60*1000
          minutesms = ms % 60000; // 60*1000
          sec = Math.floor(minutesms / 1000);

          let times = [];
          if (days) times.push(days + (days == 1 ? " dag" : " dager"))
          if (hours) times.push(hours + (hours == 1 ? " time" : " timer"))
          if (minutes) times.push(minutes + (short ? " min" : (minutes == 1 ? " minutt" : " minutter")))
          if (sec && !(minutes || hours || days)) times.push(sec + (short ? " sek" : (sec == 1 ? " sekund" : " sekunder")))

          if (!times.length) times.push(0 + (short ? " sek" : " sekunder"))

          return times.join(", ")
        }
        
        // https://ukeplan.lillestrom.kommune.no/js/site.js
        function ISO8601_week_no(dt) {
            var tdt = new Date(dt.valueOf());
            var dayn = (dt.getDay() + 6) % 7;
            tdt.setDate(tdt.getDate() - dayn + 3);
            var firstThursday = tdt.valueOf();
            tdt.setMonth(0, 1);
            if (tdt.getDay() !== 4) {
                  tdt.setMonth(0, 1 + ((4 - tdt.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - tdt) / 604800000);
        }
        
        function formatXML(text) {
          return text.replace(/&/g, "&amp;");
        }
    </script>
  </body>
</html>